# 開発コンテキストの引き継ぎ依頼 (kpe_note)
現在開発中の「レッスン予約ポータル（KIDS PLUS）」の続きをお願いします。
以下の仕様と現状を理解した上で、指示を待ってください。

## 1. システム概要
* **目的:** 保育園・学童等の施設向けレッスン予約管理、講師スケジュール管理、AppSheet連携
* **構成:**
    1. **Google AppSheet:** データベース管理、管理者用UI、Automation（`kpe_db2`）
    2. **GAS (Backend / kpe_gas):** **【最重要】** メール自動送信、カレンダー同期、定期メンテナンス、AppSheet連携、**APIエンドポイント**
    3. **GAS (Frontend / kpe_Portal):** 法人ポータル（Web予約）、キャンセル画面、スケジュール確認画面（HTML提供）
* **データソース:** Google Spreadsheet (`kpe_db2`)

## 2. kpe_gas (Backend) ファイル構成
**役割:** システムのバックエンド処理、定期実行、API提供。AppSheet Automationから直接呼ばれる関数も含む。

| ファイル名 | 役割・機能 | 備考 |
| :--- | :--- | :--- |
| **Config.gs** | **設定** | スプレッドシートID (`1sbFPxzpilekkJ9OsdJ0140AsdyLy5AX4xfo0PSg4as8`) の定義。 |
| **Utils.gs** | **汎用関数** | `getShortId`(UUID生成), `findRowData`, `youbiToNumber`, `sheetToObjects` 等のヘルパー関数。 |
| **Mail.gs** | **メール送信** | WordPress連携URLを含む通知。`sendDailyReminders`, `sendWeeklySchedule`, `sendMonthlyConfirmation`。 |
| **Automation.gs** | **AppSheet連携** | AppSheetのBotから呼ばれる関数。`runCancellationAutomation` (解約・キャンセル処理)。 |
| **BatchCreation.gs** | **一括作成** | `createScheduleBatch` (定期スケジュール展開), `createInitialLessonSlots_Triggered` (講師追加時の枠作成)。 |
| **CalendarSync.gs** | **カレンダー** | `addEventToCorporateCalendar` (法人＆マスターCalへの登録・MeetURL発行), `deleteEventFromCorporateCalendar`。 |
| **Maintenance.gs** | **定期メンテ** | `createDailyMaintenance` (毎日実行Bot)。90日後の枠を自動追加する。 |
| **ManualSync.gs** | **手動ツール** | `syncExistingReservations` (既存予約のカレンダー一括同期)。 |
| **WebApp.gs** | **API** | `doGet`/`doPost`。外部からのリクエストに対し**JSON**を返す。キャンセル処理(`cancel_single`, `cancel_monthly`)の受付。 |

## 3. kpe_Portal (Frontend) ファイル構成
**役割:** ユーザーインターフェース（HTML）の提供。

| ファイル名 | 役割・機能 | 備考 |
| :--- | :--- | :--- |
| **Config.gs** | **設定** | `PropertiesService`を使用し、環境変数を管理。 |
| **Main.gs** | **サーバーサイド** | `doGet` (画面ルーティング), `login`等の`index.html`用関数。HTMLテンプレートへのデータ渡し。 |
| **index.html** | **法人ポータル** | 既存の予約カレンダーUI。FullCalendar使用。 |
| **cancel.html** | **キャンセル画面** | 単発予約キャンセル用UI。 |
| **schedule.html** | **スケジュール画面** | 翌月スケジュール確認・一括登録用UI。 |

## 4. データベース構成 (AppSheet Tables / Google Sheets)
| テーブル名 | シート名 | Key | Label | 主なカラム・役割 |
| :--- | :--- | :--- | :--- | :--- |
| **参加予約** | 参加予約 | 予約ID | 予約ID | **トランザクション**: 施設ID, ステータス(予約済/キャンセル済), レッスン日, 時間名, カレンダーイベントID |
| **レッスン枠** | レッスン枠 | レッスン枠ID | カレンダー表示名 | **予約枠**: 講師ID, レッスン日, 時間名 |
| **定期スケジュール** | 定期スケジュール | 定期ID | 定期ID | **マスタ(定期)**: 契約開始/終了日, 曜日, 時間名 |
| **施設マスタ** | 施設マスタ | 施設ID | 施設名 | **マスタ**: 法人ID, 担当講師ID, 個別MeetID |
| **法人マスタ** | 法人マスタ | 法人ID | 法人名 | **マスタ**: 法人共通MeetID, 連携カレンダーID |
| **講師マスタ** | 講師マスタ | 講師ID | 講師名 | **マスタ**: 勤務曜日, 契約開始日 |
| **時間割マスタ** | 時間割マスタ | 時間名 | 表示用時間名 | **マスタ**: 開始時間, 終了時間 |
| **祝日マスタ** | 祝日マスタ | 日付 | 祝日名 | **マスタ**: 祝日設定 |
| **変更履歴** | 変更履歴 | 履歴ID | 履歴ID | **ログ**: 操作ログ記録 |
| **予約申請** | 予約申請 | 申請ID | - | **ワークフロー**: 申請種別, 変更後希望日時, 理由 |
| **解約申請** | 解約申請 | 解約ID | - | **ワークフロー**: 施設ID, 解約日, 実行日時 |
| **一括講師変更** | 一括講師変更 | 操作ID | - | **処理**: 変更元講師ID, 変更先講師ID, 実行日時 |
| **ユーザーマスタ** | ユーザーマスタ | Email | 氏名 | **権限管理**: 役割(Enum), 担当ID, 担当ID_Key |

## 5. AppSheet Automation 設定 (kpe_gas連携)
AppSheetのBotがトリガーとなり、GASの特定の関数を実行する仕組みが構築されている。

| Bot名 | イベント (Trigger) | 実行プロセス (Task) | 呼び出すGAS関数 | 引数 (Parameters) |
| :--- | :--- | :--- | :--- | :--- |
| **GAS 契約時一括作成ボット** | 新規契約の追加 (定期スケジュール: Adds) | GAS実行_参加予約作成 | `createScheduleBatch` | `teikiID` = `[定期ID]` |
| **GAS 講師追加時レッスン枠作成ボット** | 講師の新規追加 (講師マスタ: Adds) | GAS実行_レッスン枠作成 | `createInitialLessonSlots_Triggered` | `koushiID` = `[講師ID]` |
| **毎日自動更新ボット** | 毎日定時実行 (Scheduled) | GAS実行_1日分追加 | `createDailyMaintenance` | `teikiID` = `[定期ID]` (For each row in table) |
| **解約申請時** | 解約申請 (解約申請: Adds) | GAS解約処理実行 | `runCancellationAutomation` | `facilityId` = `[施設ID]`, `dateStr` = `[解約日]` |

## 6. 現在のエラー状況 (Critical)
**GAS実行ログ (`kpe_gas`) より:**
* **`syncNewReservations` (時間主導型トリガー)**: 頻繁に「失敗しました」ステータスで終了している。原因調査が必要。
* **`sendMonthlyConfirmation`**: 一部実行で失敗している。

## 7. 開発・運用の注意点 (Strict Rules)
1.  **kpe_gasの保護:** AppSheet Automationや定期トリガーがこのプロジェクトの関数（`Automation.gs`, `Mail.gs`等）に依存しているため、**UI側の都合でこちらの構造を変更してはならない。**
2.  **役割の分離:**
    * `kpe_gas`: ロジック、DB操作、API、バッチ処理 (JSON出力)
    * `kpe_Portal`: 画面表示、ユーザー入力 (HTML出力)
3.  **UI要件:** ポータル画面では時間コード（`am3`等）をユーザーに見せず、必ず整形された時間（`10:00 - 11:00`）を表示する。